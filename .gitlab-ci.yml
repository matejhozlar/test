stages:
  - build
  - deploy

build_project:
  stage: build
  image: node:20
  before_script:
    - apt-get update && apt-get install -y \
      libreoffice-core libreoffice-common \
      libreoffice-writer libreoffice-draw \
      ghostscript \
      unzip curl git
    - npm install -g npm
  script:
    - echo "Setting up working directory..."
    - mkdir -p /app
    - cp -r . /app
    - cd /app

    - echo "Installing server dependencies..."
    - cp docker/package.json .
    - cp docker/package-lock.json .
    - npm install

    - echo "Running docx-to-html script..."
    - node docx-to-html.js

    - echo "Building client..."
    - cd client
    - npm install
    - npm run build
    - cd ..

    - echo "Preparing /output directory..."
    - mkdir -p /build-output/client/dist
    - cp -r client/dist /build-output/client/
    - cp -r server /build-output/server/
    - cp package.json package-lock.json .env /build-output/

  artifacts:
    paths:
      - /build-output
    expire_in: 1 hour

deploy_to_github:
  stage: deploy
  image: alpine:latest
  needs: [build_project]
  only:
    - main
  before_script:
    - apk add --no-cache git
  script:
    - echo "Cloning existing repo with history..."
    - git clone https://${DEPLOY_USERNAME}:${DEPLOY_TOKEN}@aeegitlab.honeywell.com/H607726/manuals-website-deployment.git deployment-repo
    - cd deployment-repo

    - echo "Cleaning old files (except .git)..."
    - find . -mindepth 1 -maxdepth 1 ! -name '.git' -exec rm -rf {} +

    - echo "Copying new build output into repo..."
    - cp -r /build-output/* .

    - git config user.name "gitlab-ci"
    - git config user.email "ci@example.com"
    - git add .
    - git commit -m "Automated deployment" || echo "No changes to commit"
    - git push origin main
